<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Scheduler - Starship Edition</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://apis.google.com https://accounts.google.com;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
        img-src 'self';
        connect-src 'self' https://www.googleapis.com;
        frame-src 'self' https://accounts.google.com;
    ">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0a0a;
            color: #ffffff;
        }

        .container {
            max-width: 900px;
        }

        .card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 0 15px rgba(102, 204, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(102, 204, 255, 0.3);
        }

        .btn {
            background-color: transparent;
            border: 1px solid #66ccff;
            color: #66ccff;
            padding: 10px 20px;
            font-weight: 700;
            transition: background-color 0.3s, color 0.3s;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            text-transform: uppercase;
        }

        .btn:hover {
            background-color: #66ccff;
            color: #0a0a0a;
        }

        .loading-spinner {
            border: 4px solid rgba(102, 204, 255, 0.3);
            border-top: 4px solid #66ccff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #api-key-modal {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 0 25px rgba(102, 204, 255, 0.3);
        }

        input[type="text"] {
            background-color: #0a0a0a;
            border: 1px solid #333;
            color: #ffffff;
        }
    </style>
</head>
<body class="p-6 md:p-12">

<div class="container mx-auto">
    <header class="text-center mb-10">
        <h1 class="text-5xl font-bold mb-2 text-[#66ccff]">GOOGLANNER</h1>
        <p class="text-lg text-gray-400">Weekly Mission Planner</p>
        <div class="w-1/2 mx-auto mt-4 border-b-2 border-[#333]"></div>
    </header>

    <div id="tasks-container" class="space-y-6">
        <!-- Task cards will be generated here by JavaScript -->
    </div>

    <div id="status-message" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-700 text-white text-center p-3 rounded-xl shadow-lg transition-opacity duration-300 opacity-0 hidden"></div>
</div>

<div id="api-key-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
    <div class="modal-content p-8 rounded-lg shadow-2xl max-w-md w-full text-center">
        <h2 class="text-2xl font-bold text-[#66ccff] mb-4">ACCESS CREDENTIALS REQUIRED</h2>
        <p class="text-gray-400 mb-6">Enter your Google API Key and Client ID to synchronize with the mothership.</p>
        <input type="text" id="google-api-key-input" placeholder="Enter Google API Key" class="w-full mb-4 p-3 rounded-md">
        <input type="text" id="google-client-id-input" placeholder="Enter Google Client ID" class="w-full mb-4 p-3 rounded-md">
        <button id="save-api-key-btn" class="w-full bg-[#66ccff] text-[#0a0a0a] p-3 rounded-md font-bold hover:bg-opacity-80 transition-colors">CONNECT</button>
    </div>
</div>

<script>
    // Configuration
    const API_KEY_KEY = 'google_api_key';
    const CLIENT_ID_KEY = 'google_client_id';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest", "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
    const SCOPES = "https://www.googleapis.com/auth/tasks https://www.googleapis.com/auth/calendar";

    let gapiLoaded = false;
    let gisLoaded = false;
    let tokenClient;
    let apiKey;
    let clientId;

    const tasks = [
        { day: 'Monday', project: 'SELLING', task: 'Search for suppliers online.', notes: 'Dedicate 15-20 minutes to find at least one potential supplier for your "SELLING" project.' },
        { day: 'Tuesday', project: 'OakFit', task: 'Find one new video on a specific workout or exercise.', notes: 'Spend 10-15 minutes on YouTube or a fitness blog. Just find and bookmark it for later.' },
        { day: 'Wednesday', project: 'Інвестування (Investing)', task: 'Review your investment checklist.', notes: 'Spend 15 minutes reviewing the existing checklist. No need to research or act on anything yet.' },
        { day: 'Thursday', project: 'SELLING', task: 'Research the supplier you found on Monday.', notes: 'Do a quick search on reviews or the company\'s background. Aim for 15 minutes of focused research.' },
        { day: 'Friday', project: 'OakFit', task: 'Plan your OakFit training schedule.', notes: 'Spend 20 minutes to jot down a rough workout plan for the next week, incorporating the new video you found on Tuesday.' },
        { day: 'Saturday', project: 'Інвестування (Investing)', task: 'Brainstorm one new investment idea.', notes: 'Take 30 minutes to think about a new idea. This is for creative thinking, not deep analysis.' },
        { day: 'Sunday', project: 'SELLING', task: 'Re-evaluate the location of your business.', notes: 'Spend 30 minutes thinking about where you might be able to sell your product. You\'re just thinking about options, not making a decision.' },
    ];

    const tasksContainer = document.getElementById('tasks-container');
    const statusMessage = document.getElementById('status-message');
    const apiKeyModal = document.getElementById('api-key-modal');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const googleApiKeyInput = document.getElementById('google-api-key-input');
    const googleClientIdInput = document.getElementById('google-client-id-input');

    // Function to render tasks
    function renderTasks() {
        tasksContainer.innerHTML = '';
        tasks.forEach((task, index) => {
            const card = document.createElement('div');
            card.className = 'card p-6 shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';
            card.innerHTML = '
                <div class="flex-grow">
                    <div class="text-sm font-semibold uppercase text-[#66ccff]">' + task.day + '</div>
                    <div class="text-xl font-bold mt-1 text-white">' + task.task + '</div>
                    <div class="text-sm text-gray-400 mt-2">' + task.notes + '</div>
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2 mt-4 md:mt-0">
                    <button class="btn" data-index="' + index + '" data-action="tasks">
                        <i class="fas fa-list-check mr-2"></i>Tasks
                    </button>
                    <button class="btn" data-index="' + index + '" data-action="calendar">
                        <i class="fas fa-calendar-plus mr-2"></i>Calendar
                    </button>
                </div>
            ';
            tasksContainer.appendChild(card);
        });

        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', handleButtonClick);
        });
    }

    // Function to handle button clicks
    async function handleButtonClick(event) {
        const button = event.currentTarget;
        const action = button.dataset.action;
        const index = button.dataset.index;
        const task = tasks[index];

        showLoading(button);

        try {
            await ensureAuth();
            if (action === 'tasks') {
                await addTask(task);
            } else if (action === 'calendar') {
                await addCalendarEvent(task);
            }
            showStatusMessage('Task added to ' + action + '!', true);
        } catch (error) {
            console.error('Error:', error);
            showStatusMessage('Failed to add task. Please try again.', false);
        } finally {
            hideLoading(button, action);
        }
    }

    // Loading and status functions
    function showLoading(button) {
        button.innerHTML = '<div class="loading-spinner mx-auto"></div>';
        button.disabled = true;
    }

    function hideLoading(button, action) {
        button.disabled = false;
        if (action === 'tasks') {
            button.innerHTML = '<i class="fas fa-list-check mr-2"></i>Tasks';
        } else if (action === 'calendar') {
            button.innerHTML = '<i class="fas fa-calendar-plus mr-2"></i>Calendar';
        }
    }

    function showStatusMessage(message, isSuccess) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('opacity-0', 'hidden');
        statusMessage.classList.add(isSuccess ? 'bg-green-600' : 'bg-red-600');
        statusMessage.classList.add('opacity-100');
        setTimeout(() => {
            statusMessage.classList.remove('opacity-100');
            statusMessage.classList.add('opacity-0');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 300);
        }, 3000);
    }

    // Google API functions
    async function loadGapi() {
        return new Promise((resolve) => {
            if (gapiLoaded) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                gapi.load('client', () => {
                    gapiLoaded = true;
                    resolve();
                });
            };
            document.head.appendChild(script);
        });
    }

    async function loadGis() {
        return new Promise((resolve) => {
            if (gisLoaded) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = () => {
                gisLoaded = true;
                resolve();
            };
            document.head.appendChild(script);
        });
    }

    async function ensureAuth() {
        await loadGapi();
        await loadGis();

        return new Promise((resolve, reject) => {
            if (gapi.client.getToken() !== null) {
                resolve();
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        reject(new Error(tokenResponse.error));
                    } else {
                        resolve();
                    }
                },
            });

            tokenClient.requestAccessToken({ prompt: 'consent' });
        });
    }

    async function addTask(task) {
        await gapi.client.init({ apiKey: apiKey, discoveryDocs: DISCOVERY_DOCS });
        const requestBody = {
            title: '[${task.project}] - ${task.task}',
            notes: task.notes,
        };
        const response = await gapi.client.tasks.tasks.insert({
            tasklist: '@default',
            resource: requestBody,
        });
        console.log('Task added:', response.result);
    }

    async function addCalendarEvent(task) {
        await gapi.client.init({ apiKey: apiKey, discoveryDocs: DISCOVERY_DOCS });
        const today = new Date();
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dayIndex = days.indexOf(task.day);
        
        let targetDate = new Date(today);
        targetDate.setDate(today.getDate() + (dayIndex + 7 - today.getDay()) % 7);
        targetDate.setHours(19, 0, 0); // Suggest a time after work, e.g., 7 PM

        const event = {
            summary: '[${task.project}] - ${task.task}',
            description: task.notes,
            start: {
                dateTime: targetDate.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            },
            end: {
                dateTime: new Date(targetDate.getTime() + 30 * 60000).toISOString(), // 30 minutes duration
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            },
        };
        const response = await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event,
        });
        console.log('Event created:', response.result);
    }

    // Initial setup
    function setupApp() {
        apiKey = localStorage.getItem(API_KEY_KEY);
        clientId = localStorage.getItem(CLIENT_ID_KEY);

        if (!apiKey || !clientId) {
            apiKeyModal.classList.remove('hidden');
        } else {
            renderTasks();
        }
    }

    // Save API key handler
    saveApiKeyBtn.addEventListener('click', () => {
        const key = googleApiKeyInput.value.trim();
        const id = googleClientIdInput.value.trim();

        if (key && id) {
            localStorage.setItem(API_KEY_KEY, key);
            localStorage.setItem(CLIENT_ID_KEY, id);
            apiKey = key;
            clientId = id;
            apiKeyModal.classList.add('hidden');
            renderTasks();
        } else {
            alert('Please enter both API Key and Client ID.');
        }
    });

    window.onload = () => {
        setupApp();
    };
</script>

</body>
</html>